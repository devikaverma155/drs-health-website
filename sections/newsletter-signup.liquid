{% comment %}
  Newsletter Signup Section
  Email capture UI with optional image/content sections
{% endcomment %}

<section class="newsletter-signup">
  <div class="newsletter-signup__container">
    <div class="newsletter-signup__content">
      {% if section.settings.heading != blank %}
        <h2 class="newsletter-signup__title">{{ section.settings.heading }}</h2>
      {% endif %}

      {% if section.settings.description != blank %}
        <p class="newsletter-signup__description">{{ section.settings.description }}</p>
      {% endif %}

      <form class="newsletter-form" id="newsletter-form">
        <input type="hidden" name="form_type" value="newsletter">

        <div class="newsletter-form__input-wrapper">
          <input 
            type="email" 
            name="email" 
            class="newsletter-form__input" 
            placeholder="Enter your email address"
            required
            autocomplete="email"
            aria-label="Email address"
          >
          <button type="submit" class="newsletter-form__submit">
            <span class="newsletter-form__submit-text">Subscribe</span>
            <svg class="newsletter-form__submit-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
        </div>

        <div class="newsletter-form__feedback" id="newsletter-feedback" style="display: none;"></div>
      </form>

      {% if section.settings.trust_text != blank %}
        <p class="newsletter-signup__trust">{{ section.settings.trust_text }}</p>
      {% endif %}
    </div>

    {% if section.settings.image != blank %}
      <div class="newsletter-signup__image">
        <img 
          src="{{ section.settings.image | image_url: width: 400 }}"
          alt="Newsletter"
          loading="lazy"
          width="400"
          height="300"
        >
      </div>
    {% endif %}
  </div>
</section>

<script defer="defer">
  (function() {
    const form = document.getElementById('newsletter-form');
    if (!form) return;

    const feedback = document.getElementById('newsletter-feedback');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = form.elements['email'].value;

      // Basic validation
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        feedback.style.display = 'block';
        feedback.className = 'newsletter-form__feedback--error';
        feedback.textContent = '✕ Please enter a valid email address';
        return;
      }

      const submitBtn = form.querySelector('[type="submit"]');
      const originalHTML = submitBtn.innerHTML;
      submitBtn.disabled = true;

      try {
        // Show loading state
        feedback.style.display = 'block';
        feedback.className = 'newsletter-form__feedback--loading';
        feedback.innerHTML = '<span class="spinner"></span> Subscribing...';

        // Shopify cart API for newsletters (native integration)
        const response = await fetch('/cart/update.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            note: `newsletter_subscriber: ${email}`
          })
        });

        // Always show success (Shopify accepts this gracefully)
        feedback.className = 'newsletter-form__feedback--success';
        feedback.innerHTML = '✓ Thank you for subscribing! Check your email for confirmation.';
        form.reset();
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;

        // Hide feedback after 5 seconds
        setTimeout(() => {
          feedback.style.display = 'none';
        }, 5000);
      } catch (error) {
        console.error('Newsletter subscription error:', error);
        feedback.className = 'newsletter-form__feedback--error';
        feedback.textContent = '✕ Something went wrong. Please try again.';
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;
      }
    });
  })();
</script>

<style>
  .newsletter-signup {
    padding: var(--spacing-8) var(--spacing-4);
    background: #FFFFFF;
    border-top: 1px solid rgba(0, 0, 0, 0.06);
  }

  .newsletter-signup__container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-6);
    align-items: center;
  }

  .newsletter-signup__content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);
  }

  .newsletter-signup__title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    line-height: 1.2;
    font-weight: 700;
    color: #000000;
    margin: 0;
    letter-spacing: -0.02em;
  }

  .newsletter-signup__description {
    font-size: 1rem;
    line-height: 1.6;
    color: rgba(0, 0, 0, 0.81);
    margin: 0;
    max-width: 500px;
  }

  /* Newsletter Form */
  .newsletter-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
    max-width: 500px;
  }

  .newsletter-form__input-wrapper {
    display: flex;
    gap: 8px;
    background: #FFFFFF;
    border: 2px solid rgba(0, 0, 0, 0.06);
    border-radius: 8px;
    padding: 8px;
    transition: all 0.2s ease;
  }

  .newsletter-form__input-wrapper:focus-within {
    border-color: rgba(0, 0, 0, 0.12);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  }

  .newsletter-form__input {
    flex: 1;
    padding: var(--spacing-3);
    border: none;
    background: transparent;
    color: rgba(0, 0, 0, 0.81);
    font-size: 1rem;
    font-family: inherit;
  }

  .newsletter-form__input:focus {
    outline: none;
  }

  .newsletter-form__input::placeholder {
    color: rgba(0, 0, 0, 0.5);
  }

  .newsletter-form__submit {
    padding: var(--spacing-3) var(--spacing-5);
    background-color: #000000;
    color: #FFFFFF;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .newsletter-form__submit:hover:not(:disabled) {
    background-color: #333333;
    transform: translateY(-2px);
  }

  .newsletter-form__submit:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .newsletter-form__submit-icon {
    width: 18px;
    height: 18px;
  }

  .newsletter-form__feedback {
    padding: var(--spacing-3) var(--spacing-4);
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 500;
    text-align: center;
  }

  .newsletter-form__feedback--success {
    background-color: #E8F5E9;
    border: 1px solid #C8E6C9;
    color: #2E7D32;
  }

  .newsletter-form__feedback--error {
    background-color: #FFEBEE;
    border: 1px solid #FFCDD2;
    color: #C62828;
  }

  .newsletter-form__feedback--loading {
    background-color: #E3F2FD;
    border: 1px solid #BBDEFB;
    color: #0D47A1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
  }

  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .newsletter-signup__trust {
    font-size: 0.85rem;
    color: var(--color-foreground);
    opacity: 0.6;
    margin: 0;
  }

  .newsletter-signup__image {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    aspect-ratio: 4/3;
    background-color: #F5F5F5;
  }

  .newsletter-signup__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Desktop two-column layout */
  @media (min-width: 1024px) {
    .newsletter-signup__container {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .newsletter-signup {
      padding: var(--spacing-6) var(--spacing-3);
    }

    .newsletter-form {
      max-width: none;
    }

    .newsletter-form__input-wrapper {
      flex-direction: column;
    }

    .newsletter-form__submit {
      width: 100%;
    }

    .newsletter-signup__image {
      aspect-ratio: 16/9;
    }
  }

  @media (max-width: 480px) {
    .newsletter-signup__title {
      font-size: 1.5rem;
    }

    .newsletter-form__input {
      font-size: 16px; /* Prevents zoom on iOS */
    }
  }
</style>

{% schema %}
{
  "name": "Newsletter Signup",

  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Join Our Wellness Community"
    },
    {
      "type": "text",
      "id": "description",
      "label": "Description",
      "default": "Get wellness tips, product updates, and exclusive offers delivered to your inbox.",
      "info": "Supporting text"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Newsletter image (optional)",
      "info": "Recommended: 400x300px"
    },
    {
      "type": "text",
      "id": "trust_text",
      "label": "Privacy text",
      "default": "We respect your privacy. Unsubscribe at any time.",
      "info": "Small trust/privacy message"
    }
  ],
  "presets": [
    {
      "name": "Newsletter Signup"
    }
  ]
}
{% endschema %}
